<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>peerjs</title>
</head>
<body>
  <p>receiver</p>
  <video id="remoteVideo" autoplay playsinline width="240" height="240"></video>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script type="text/javascript">
    const peer = new Peer();
    let lastPeerId = null;
    
    console.log('[peer]:',peer);

    peer.on('open', (id) => {
      if (peer.id === null) {
          console.log('Received null id from peer open');
          peer.id = lastPeerId;
      } else {
          lastPeerId = peer.id;
      }

      console.log('ID: ' + peer.id);
      receiverDoc.set({pid: id})
    })
    peer.on('connection', (conn) => { 
      console.log('[connection]:',conn);
      conn.on('data', (data) => {
        console.log('[data]:',data);
        
      })
    });

    peer.on('disconnected', function () {
        console.log('Connection lost. Please reconnect');

        // Workaround for peer.reconnect deleting previous id
        peer.id = lastPeerId;
        peer._lastServerId = lastPeerId;
        peer.reconnect();
    });
    const remoteVideo = document.getElementById('remoteVideo');
    const getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    peer.on('call', (call) => {
      console.log('[call]:',call);
      call.answer();
      call.on('stream', (remoteStream)=> {
        console.log('[remoteStream]:',remoteStream);
          
        remoteVideo.srcObject = remoteStream
      })
    })
    console.log('[firebase]:',firebase);
    
  
  </script>

  <script type="text/javascript">

  const firebaseConfig = {
        apiKey: "AIzaSyADgpMwwDlzBdvJ1IjbBhgsjMRAZO8EuQE",
        authDomain: "webrtc-app-3cd90.firebaseapp.com",
        projectId: "webrtc-app-3cd90",
        storageBucket: "webrtc-app-3cd90.appspot.com",
        messagingSenderId: "763306657243",
        appId: "1:763306657243:web:e125f88808cfdc5f3593fe",
        measurementId: "G-M696NP1J1B"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const firestore = firebase.firestore();

    const peersDoc = firestore.collection('peers');
    const receiverDoc = peersDoc.doc('receiver');
  // const answerCandidates = callDoc.collection('answerCandidates');
  </script>
</body>
</html>