<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/socket.io/socket.io.js"></script>
    <script src="/receiver.js" defer></script>
    <title>Socket.io - Receiver</title>
  </head>
  <body>
    <video id="webcamVideo" autoplay playsinline></video>
    <video
      id="remoteVideo"
      autoplay
      playsinline
      width="240"
      height="240"
    ></video>

    <script type="text/javascript">
      const socket = io();
      const pc = new RTCPeerConnection();
      let dataChannel = null;
      // const dataChannel = pc.createDataChannel('channel');

      // client-side
      socket.on("connect", () => {
        console.log(socket.id); // x8WIv7-mJelg7on_ALbx
      });

      socket.on("offer", (offer) => {
        handleOffer(offer);
      });

      socket.on("candidate", (candidate) => {
        handeCandidate(candidate);
      });

      let localStream = null;
      let remoteStream = null;

      const localVideo = document.getElementById("webcamVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const getUserMedia = async () => {
        // const constraints = {
        //   "video": {
        //     "width": 320,
        //     "height": 240
        //   },
        //   "audio": false
        // }

        // localStream = await navigator.mediaDevices.getUserMedia(constraints)
        remoteStream = new MediaStream();
        // Push tracks from local stream to peer connection
        // localStream.getTracks().forEach((track) => {
        //   pc.addTrack(track, localStream);
        // });

        // Pull tracks from remote stream, add to video stream
        pc.ontrack = (event) => {
          event.streams[0].getTracks().forEach((track) => {
            remoteStream.addTrack(track);
          });
        };

        // webcamVideo.srcObject = localStream;
        remoteVideo.srcObject = remoteStream;
      };

      getUserMedia();

      pc.onicecandidate = (event) => {
        console.log("[event]:", event.candidate);
      };

      const handleOffer = async (offer) => {
        pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("answer", answer);
      };

      const handeCandidate = async (candidate) => {
        try {
          await pc.addIceCandidate(candidate);
        } catch (e) {
          console.error("Error adding received ice candidate", e);
        }
      };

      pc.ondatachannel = (event) => {
        console.log("[event]:");
        dataChannel = event.channel;
        dataChannel.onopen = (ev) => {
          console.log("[datachannnelopen]:");
        };

        dataChannel.onmessage = (ev) => {
          console.log("[Data]:", ev.data);
        };
      };

      pc.onconnectionstatechange = (ev) => {
        switch (pc.connectionState) {
          case "new":
          case "checking":
            console.log("[PEER CONNECTING]:");
            break;
          case "connected":
            console.log("[PEER CONECTED!]");
            break;
          case "disconnected":
            console.log("[PEER DISCONNECTING!]");
            break;
          case "closed":
            console.log("[PEER OFFLINE]:");
            break;
          case "failed":
            console.log("[PEER ERROR]:");
            break;
          default:
            break;
        }
      };
    </script>
  </body>
</html>
